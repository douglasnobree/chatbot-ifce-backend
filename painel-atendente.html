<!-- Painel do Atendente para visualizar e entrar em atendimentos abertos -->
<!doctype html>
<html lang="pt-br">
  <head>
    <meta charset="UTF-8" />
    <title>Painel do Atendente - Chatbot IFCE</title>
    <script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>
    <style>
      body {
        font-family: Arial, sans-serif;
        max-width: 1000px;
        margin: 0 auto;
        padding: 20px;
      }
      #atendimentos {
        margin-bottom: 20px;
      }
      #mensagens {
        border: 1px solid #ccc;
        height: 300px;
        overflow: auto;
        margin-bottom: 10px;
        padding: 10px;
        background-color: #f9f9f9;
      }
      .atendimento {
        margin-bottom: 8px;
        padding: 10px;
        background-color: #f0f8ff;
        border-radius: 4px;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }
      .atendimento button {
        margin-left: 10px;
        padding: 5px 10px;
        background-color: #4caf50;
        color: white;
        border: none;
        border-radius: 4px;
        cursor: pointer;
      }
      .atendimento button:hover {
        background-color: #45a049;
      }
      .mensagem-usuario {
        text-align: left;
        background-color: #e3f2fd;
        padding: 8px;
        margin: 5px 0;
        border-radius: 10px 10px 10px 0;
        max-width: 70%;
      }
      .mensagem-usuario.whatsapp {
        background-color: #dcf8c6;
        border-left: 3px solid #25d366;
      }
      .mensagem-atendente {
        text-align: right;
        background-color: #e8f5e9;
        padding: 8px;
        margin: 5px 0 5px auto;
        border-radius: 10px 10px 0 10px;
        max-width: 70%;
      }
      .login-form {
        background-color: #f5f5f5;
        padding: 15px;
        border-radius: 5px;
        margin-bottom: 20px;
      }
      .header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
      }
      .input-group {
        display: flex;
        gap: 10px;
        margin-bottom: 10px;
      }
      input,
      button {
        padding: 8px;
        border-radius: 4px;
        border: 1px solid #ccc;
      }
      button {
        cursor: pointer;
        background-color: #2196f3;
        color: white;
        border: none;
      }
      button:hover {
        background-color: #0b7dda;
      }
      #msg {
        flex: 1;
      }
    </style>
  </head>
  <body>
    <div class="header">
      <h2>Painel do Atendente - IFCE</h2>
      <div>
        <span id="statusConexao">‚ö†Ô∏è Desconectado</span>
      </div>
    </div>

    <div class="login-form">
      <h3>Identifica√ß√£o do Atendente</h3>
      <div class="input-group">
        <label
          >ID do Atendente: <input id="atendenteId" value="atend-001"
        /></label>
        <label>Nome: <input id="nomeAtendente" value="Atendente IFCE" /></label>
        <label>Setor: <input id="setorAtendente" value="Comunica√ß√£o" /></label>
        <button onclick="conectarPainel()">Conectar</button>
      </div>
    </div>

    <div id="painel" style="display: none">
      <h3>Atendimentos Aguardando Atendente</h3>
      <div id="atendimentos"></div>
      <div id="chat" style="display: none">
        <h3>Chat com Usu√°rio</h3>
        <div class="info-protocolo">
          <p><strong>Protocolo:</strong> <span id="protocoloAtual"></span></p>
          <p><strong>Setor:</strong> <span id="setorAtual"></span></p>
          <button onclick="encerrarAtendimento()">Encerrar Atendimento</button>
        </div>
        <div id="mensagens"></div>
        <div class="input-group">
          <input
            id="msg"
            placeholder="Digite sua mensagem"
            onkeypress="if(event.keyCode === 13) enviar()"
          />
          <button onclick="enviar()">Enviar</button>
        </div>
      </div>
    </div>

    <script>
      let socket;
      let atendimentosAbertos = [];
      let sessao_idAtual = null;
      let nomeAtendente = '';
      let setorAtendente = '';
      let atendenteId = '';

      function conectarPainel() {
        nomeAtendente = document.getElementById('nomeAtendente').value;
        setorAtendente = document.getElementById('setorAtendente').value;
        atendenteId = document.getElementById('atendenteId').value;

        if (!nomeAtendente || !setorAtendente || !atendenteId) {
          alert('Por favor, preencha todos os campos de identifica√ß√£o.');
          return;
        }

        socket = io('http://localhost:3000/atendimento');
        document.getElementById('painel').style.display = '';
        document.getElementById('statusConexao').innerHTML = 'üü¢ Conectado';

        buscarAtendimentos();
        setInterval(buscarAtendimentos, 3000);
        socket.on('connect', () => {
          console.log('Conectado ao servidor');
          document.getElementById('statusConexao').innerHTML = 'üü¢ Conectado';
        });

        socket.on('disconnect', () => {
          document.getElementById('statusConexao').innerHTML =
            'üî¥ Desconectado';
        });

        // Eventos adicionais para depura√ß√£o
        socket.on('connect_error', (error) => {
          console.error('Erro de conex√£o:', error);
          document.getElementById('statusConexao').innerHTML =
            'üî¥ Erro de conex√£o';
        });

        socket.on('error', (error) => {
          console.error('Erro no socket:', error);
        });

        socket.on('atendimentosAbertos', (data) => {
          atendimentosAbertos = data;
          console.log('Atendimentos Abertos:', atendimentosAbertos);
          renderAtendimentos();
        });
        socket.on('novaMensagem', (data) => {
          console.log('Nova Mensagem:', data);
          console.log('Mensagem:', data.mensagem);
          console.log('Sender:', data.sender);
          addMsg(
            data.sender === 'usuario' ? 'Usu√°rio' : nomeAtendente,
            data.mensagem,
          );
        });

        socket.on('atendenteEntrou', (data) => {
          addMsg(
            'Sistema',
            `Atendente ${data.nome} do setor ${data.setor} entrou no atendimento.`,
          );
        });

        socket.on('atendimentoEncerrado', () => {
          addMsg('Sistema', 'Este atendimento foi encerrado.');
          setTimeout(() => {
            alert('O atendimento foi encerrado.');
            fecharChat();
          }, 1000);
        });
      }

      function buscarAtendimentos() {
        if (socket && socket.connected) {
          socket.emit('listarAtendimentos');
        }
      }
      function renderAtendimentos() {
        const div = document.getElementById('atendimentos');
        div.innerHTML = '';
        if (!atendimentosAbertos.length) {
          div.innerHTML = '<i>Nenhum atendimento aguardando...</i>';
          return;
        }
        atendimentosAbertos.forEach((at) => {
          const el = document.createElement('div');
          el.className = 'atendimento';

          // Determina a origem do atendimento
          const origem =
            at.assunto && at.assunto.includes('WhatsApp') ? 'WhatsApp' : 'Web';
          const estudanteNome = at.estudante
            ? at.estudante.nome || 'N√£o identificado'
            : 'N√£o identificado';

          el.innerHTML = `
            <div>
              <strong>ID da Sess√£o:</strong> ${at.sessao_id.substring(0, 8)}... | 
              <strong>Setor:</strong> ${at.setor} | 
              <strong>Protocolo:</strong> ${at.numero} |
              <strong>Origem:</strong> ${origem} |
              <strong>Estudante:</strong> ${estudanteNome}
            </div>
            <button onclick="entrarAtendimento('${at.sessao_id}', '${at.setor}')">Atender</button>
          `;
          div.appendChild(el);
        });
      }
      function entrarAtendimento(sessao_id, setor) {
        sessao_idAtual = sessao_id;
        document.getElementById('protocoloAtual').innerText = sessao_id;
        document.getElementById('setorAtual').innerText = setor;
        document.getElementById('chat').style.display = '';
        document.getElementById('mensagens').innerHTML = '';

        // Tentando determinar origem do atendimento (Web ou WhatsApp)
        const atendimento = atendimentosAbertos.find(
          (a) => a.sessao_id === sessao_id,
        );
        const origemAtendimento =
          atendimento &&
          atendimento.assunto &&
          atendimento.assunto.includes('WhatsApp')
            ? 'WhatsApp'
            : 'Web';

        console.log(`Entrando no atendimento da sess√£o ${sessao_id}`);
        socket.emit('entrarAtendimento', {
          sessao_id,
          nome: nomeAtendente,
          setor: setorAtendente,
          atendenteId: atendenteId,
        });

        addMsg(
          'Sistema',
          `Voc√™ entrou no atendimento. O usu√°rio est√° utilizando ${origemAtendimento}. Suas mensagens ser√£o enviadas diretamente para o usu√°rio.`,
        );
      }

      function fecharChat() {
        document.getElementById('chat').style.display = 'none';
        sessao_idAtual = null;
      }

      function encerrarAtendimento() {
        if (!sessao_idAtual) return;

        if (confirm('Deseja realmente encerrar este atendimento?')) {
          socket.emit('encerrarAtendimento', { sessao_id: sessao_idAtual });
          addMsg('Sistema', 'Voc√™ encerrou este atendimento.');
          setTimeout(fecharChat, 1000);
        }
      }
      function addMsg(sender, mensagem) {
        const div = document.getElementById('mensagens');
        const msgEl = document.createElement('div');
        msgEl.className =
          sender === 'Usu√°rio' ? 'mensagem-usuario' : 'mensagem-atendente';

        if (sender === 'Sistema') {
          msgEl.style.backgroundColor = '#fffde7';
          msgEl.style.textAlign = 'center';
          msgEl.style.margin = '10px auto';
          msgEl.style.fontStyle = 'italic';
        }

        // Formata a mensagem adequadamente
        if (typeof mensagem === 'object' && mensagem !== null) {
          console.warn('Mensagem recebida como objeto:', mensagem);
          mensagem = JSON.stringify(mensagem);
        }

        msgEl.innerHTML = `<strong>${sender}:</strong> ${mensagem}`;
        div.appendChild(msgEl);
        div.scrollTop = div.scrollHeight;

        // Log para debug
        console.log(
          `Mensagem adicionada - De: ${sender}, Conte√∫do: ${mensagem.substring(0, 50)}${mensagem.length > 50 ? '...' : ''}`,
        );
      }
      function enviar() {
        const msgInput = document.getElementById('msg');
        const mensagem = msgInput.value.trim();
        if (!mensagem || !sessao_idAtual) return;

        console.log(`Enviando mensagem para sess√£o ${sessao_idAtual}`);
        socket.emit('enviarMensagem', {
          sessao_id: sessao_idAtual,
          mensagem,
          sender: 'atendente',
        });

        // N√£o precisamos mais adicionar a mensagem aqui, pois o servidor
        // ir√° emitir o evento novaMensagem para todos na sala, incluindo este cliente

        msgInput.value = '';
        msgInput.focus();
      }
    </script>
  </body>
</html>
